---
title: | 
  R-Bootcamp Report
author: 
  - Bernardo Freire Barboza da Cruz^[Hochschule Luzern, bernardo.dacruz@stud.hslu.ch]
  - Leonid Gavrilyuk^[Hochschule Luzern, leonid.gavrilyuk@stud.hslu.ch]
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    pdf_document:
        fig_caption: yes
        highlight: pygments
        keep_tex: yes
        number_sections: yes
        fig_width: 16
        fig_height: 9
        df_print: kable
---

\centering
\raggedright
\newpage
\tableofcontents
\pagebreak

```{r setup, include = FALSE}
# Set echo, include, warning, message to FALSE
knitr::opts_chunk$set(
	echo = FALSE, # prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.
	include = FALSE, # prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.
  message = FALSE, # prevents messages that are generated by code from appearing in the finished file.
	warning = FALSE # prevents warnings that are generated by code from appearing in the finished.
)
# Import libraries
library(knitr)
library(lattice)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
#toc: yes
#toc_depth: 4
```



# Introduction. 
## Project goal
The goal is to understand the dynamics in the performance of each part in each electoral district of the city. The time span in interest is **2006-2018 ???**
The questions to be answered: the portrait of the voters, identification of  relationship (if any) between such characteristics as voters' education or age and the election results of the party. 

## Data
To perform analysis, six data sets covering the time period 2006-2022 were retrieved from the Open Data platform of the City of Z端rich:

* Turnout at the city and municipal council elections, by city district, since 2006. (*Beteiligung am Urnengang der Stadt- und Gemeinderatswahlen nach Stadtquartier*)
* Municipal elections vote share, by party and electoral district, since 1913. (*Gemeinderatswahlen Stimmenanteil nach Partei und Wahlkreis*)
* Turnout at the city and municipal council elections, by age and gender, since 2006.
??
??

The data sets did not have the same content and were not organised in the same way. Each data set contained some irrelevant information - for example, historical election data since 1913 whereas the time span of interest is 2006-2018. This required data preparation activities. Each data set was prepared, subsequently all of them were merged into one final table. 

\pagebreak
# Data Preparation 
## Data set 1: Turnout at the city and municipal council elections since 2006, by city district.

The data set of dimensions 136x7 reflects how many people from each city district participated in five last elections (2006-2022). 

```{r Beteiligung_am_Urnengang 1, echo=FALSE, results='asis', include = TRUE}
#d.gen <- read.table("https://data.stadt-zuerich.ch/dataset/politik_gemeinderatswahlen_btg_urnengang_quartier_od7005/download/POL700OD7005.csv", header = TRUE, sep = ",")
d.gen <- read.table("./data/POL700OD7005.csv", header = TRUE, sep = ",")
kable(d.gen[1:6, ], caption = "Original data set: Turnout in the city and municipal council elections since 2006, by city district")

```

Examination of the dataset revealed an important issue: The territorial entity in this dataset is a city district - *"Stadtquartier"*. However, in Z端rich, the elections are held across 12 electoral districts - *"Wahlkreise"*. Each electoral district consists of several "Stadtquartiers". For example, electoral district "Kreis 1+2" unites six city districts (they are shown in the "Qname" column in the Table 1 above).  

To address the issue, the following manipulations were performed:

- In the column "Qname", the electoral district is specified in the parentheses: e.g. "Rathaus (Kreis 1)". The content of the parentheses was extracted with the **stringr package** and stored in the created column "DistrictName". 
- Rename the electoral districts to reflect the fact that some city districts are merged for the elections - for example "Kreis 1" and "Kreis 2" became "Kreis 1+2". This was done with the **dplyr mutate() function**. 
- Calculate the mean values for each group and year using **dplyr group_by() and summarise() functions** (saved as a separate data frame). The results is saved as a separate data frame, with the new column "PercentageOfDistrict".
- Calculate percentage of each district's voters relative to the total number of the city voters using **dplyr group_by() %>% summarise() %>% transmute() functions**. The results is saved as a separate data frame, with the new column "PercentageOfCity".
- Merge the dataframes with the **dplyr inner_join()**. 
- Change "Jahr" and "DistrictName" to factors with the built-in **as.factor()**

```{r Beteiligung_am_Urnengang/Preparation, echo=FALSE, include=FALSE}
#Create the "DistrictName" column that stores the content of the parenthesis. 
#E.g. Rathaus (Kreis 1) - > Kreis 1
library (stringr)
d.gen$DistrictName <- str_extract_all(d.gen$Qname,"\\([^()]+\\)")
d.gen$DistrictName <- substring(d.gen$DistrictName, 2, 
                                      nchar(d.gen$DistrictName)-1)
head(d.gen, 30)

##Create the DistrictNr column that stores only the number of the electoral district.
d.gen$DistrictNr <- str_sub(d.gen$DistrictName, 
                                    start = 6, 
                                    end = -1)
head(d.gen,10)

# to reflect the fact some city districts are merged for the elections (e.g. "Kreis 1+2")
library(dplyr)
d.gen <- d.gen %>%
  mutate(DistrictName = recode(DistrictName, 
                               'Kreis 1' = 'Kreis 1+2', 
                               'Kreis 2' = 'Kreis 1+2', 
                               'Kreis 4' = 'Kreis 4+5',
                               'Kreis 5' = 'Kreis 4+5',
                               'Kreis 7' ='Kreis 7+8',
                               'Kreis 8' ='Kreis 7+8'))
head(d.gen,34)
              
#Calculate mean by each group and year using dplyr's group_by
df_1 <- d.gen %>% group_by(Jahr, DistrictName) %>% summarise(PercentageOfDistrict =mean(Beteiligung)) 
head(df_1)

#Calculate sum of the voters for each district and year using dplyr's group_by.
#Calculate percentage of each district's voters relative to the total number of the city voters.
df_2 <- d.gen %>%
  group_by(Jahr, DistrictName) %>%
  summarise(TotalVoted=sum(teilnehmende)) %>% 
  transmute (DistrictName, PercentageOfCity = (TotalVoted/sum(TotalVoted))*100)
head(df_2)

#Merge with dplyr
df_fin <- df_1 %>% inner_join(df_2)
head(df_fin,10)

#Reorder so that DistrictName is sorted not alphabetically
#Change "DistrictName" to numeric


#Change "Jahr" and "DistrictName" to factors
df_fin$DistrictName <- as.factor(df_fin$DistrictName)
df_fin$Jahr <- as.factor(df_fin$Jahr)
sapply(df_fin, class)

#Rename Jahr to English version 

df_fin %>% 
  rename(
    Year = Jahr
    )

df_fin[order(df_fin$Jahr, df_fin$DistrictName), ]
head(df_fin, 30)



#install.packages("writexl")
#library("writexl")
#write_xlsx(df,"/Users/leonidgavrilyuk/Desktop/RBootcamp/R_Bootcamp_Feb2022/DataSets/df.xlsx")


```

```{r Beteiligung_am_Urnengang_2, echo=FALSE, results='asis', include = TRUE}
kable(df_fin[1:6, ], caption = "Final dataset: Turnout by electoral district")
```

The analysis shows that the amount of voters in each district has grown since 2006 - Z端rich residents are becoming more active in exercising their right to vote. Kreis 6 has the highest percentage of active citizens, followed by Kreis 7+8 and Kreis 10. Residents of Kreis 12 are the least interested in the elections people in Z端rich. However, when it comes to the percentage of all city voters, Kreis 12 contributes the third largest portion of votes. This means, politicians should mobilize residents of this district to gain votes on the city and national level elections. Other important districts are Kreis 7+8 (gives most votes) and Kreis 11 (second place). 

```{r plot_election_per_district, echo=FALSE, include = TRUE}

library(ggplot2)
#install.packages("cowplot")
library(cowplot)
p1 <- ggplot(data=df_fin, aes(x=Jahr, y=PercentageOfDistrict, group=DistrictName)) +
  geom_line(aes(color=DistrictName))+
  geom_point(aes(color=DistrictName)) 

p2 <- ggplot(data=df_fin, aes(x=Jahr, y=PercentageOfCity, group=DistrictName)) +
  geom_line(aes(color=DistrictName))+
  geom_point(aes(color=DistrictName)) 

plot(p1)
#plot(p2)

```

## Data set 2:  Municipal elections vote share, by party and electoral district since 1913.
The data set of dimensions 5100x6 shows the results of each party at the elections since 1913. Naturally, it contains a lot of irrelevant information because of the changes that happened sine 1913. For example, for each year there are separate rows for "Kreis 1 (before 2002)", "Kreis 2 (before 2002) and "Kreis 1+2 (after 2006)" - the districts were united in 2002. Some political parties do not exist anymore; some parties changed their names. Additionally, the table is in the long format whereas the final data set requires it to be wide. 

```{r Municipal_elections_vote_share_1, echo=FALSE, results='asis', include = TRUE}
parties <- read.table("https://data.stadt-zuerich.ch/dataset/politik_gemeinderatswahlen_stimmant_seit1913_od7000/download/POL700OD7000.csv", header = TRUE, sep = ",")

kable(parties[1:6, ], caption = "Original data set: Municipal elections vote share, by party and electoral district since 1913.")
```

The following manipulations were performed:

* Choose only relevant time period (years 2006-2018) and eight still existing parties using the **%in% operator**.
* Change the names of the electoral districts. For example, "Kreis 11 (ab 1974)" became simply "Kreis 11" - the content in the parentheses was removed with the  **stringr str_replace() function**. 
* Rename the columns with  the **dplyr %>% rename() function** to keep them in line with the other tables (e.g. "Wahlkreis" to "DistrictName").
* Remove unnecessary columns with the **dplyr %>% select() function**.
* Transform the table into wide format with the **tidyverse pivot_wider() function**.
* Merge the set with the first table "Turnout by electoral district" (see part 2.1.)

```{r Municipal_elections_vote_share_2, echo=FALSE, include=FALSE}
#Choose only relevant time period (years 2006-2018) and eight still existing parties.

library(dplyr)
parties <- parties[parties$Jahr %in% c(2006, 2010, 2014, 2018), ]

parties <- parties[parties$Partei %in% c("SP", "BGB/SVP", "GPS", "FDP", 
                              "GLP", "CVP/Die Mitte", "AL", "EVP"), ]

parties <- parties[parties$Wahlkreis %in% c("Kreis 1 + 2 (ab 2006)", "Kreis 9",
                                            "Kreis 11 (ab 1974)", "Kreis 3",
                                            "Kreis 4 + 5 (ab 2006)", "Kreis 10",
                                            "Kreis 12 (ab 1974)", "Kreis 6",
                                            "Kreis 7 + 8 (ab 2006)"), ]

#Change the names of the electoral districts.
library(stringr)
parties$Wahlkreis <- str_replace(parties$Wahlkreis, " \\s*\\([^\\)]+\\)", "")
parties

#Rename the columns to keep them in line with the other tables (e.g. "Wahlkreis" to "DistrictName"). 
parties <- parties %>% 
  rename(
    DistrictName = Wahlkreis,
    Year = Jahr,
    Party = Partei,
    Result = Stimmenanteil) %>% 
  select (-ParteiNr, -WahlkreisSort)

#Transform the table into wide format.
library(tidyr)
parties <- pivot_wider(parties, 
                                   names_from = "Party",
                                   values_from = "Result")
parties
```

```{r Municipal_elections_vote_share_3, echo=FALSE, results='asis', include = TRUE}

kable (parties[1:8, ], caption = "Final dataset: Municipal elections vote share, by party and electoral district, 2006-2018.")

```

The analysis shows that 

## Data set 3: Wealth distribution of the population in Z端rich, by district
The data set of dimensions 756x8 variables reflects how the wealth distribution in absolute terms changed over time per district and per tax class. The following table shows the accumulated wealth distribution across all districts of the city of Z端rich between the years 1999 and 2019. 

```{r import_data_wealth, echo = FALSE, cache=TRUE, include = FALSE, results='asis'} 
# Set cache to true
VermoegenSteuerKreis <- read.csv('https://data.stadt-zuerich.ch/dataset/fd_median_vermoegen_kreis_od1008/download/WIR100OD1008.csv')
```

```{r initial_data_wealth, echo = FALSE, cache=TRUE, include = TRUE, results='asis'} 
kable(VermoegenSteuerKreis[1:6,1:4], caption = "Original data set: Distribution wealth tax per category, district and year")
kable(VermoegenSteuerKreis[1:6,4:8])
```

Examinating the previous showed data revealed that the data set contains a lot of irrelevant information.
For example, the columns *"KreisSort"* and *"KreisLang"* are redundant, since the first in simply the encoding of the second in number. 
The same applies for the the columns *"SteuerTarifSort"* and *"SteuerTarifLang"*, since the first here again, is the encoding of the second in number. However, the columns *"KreisLang"* and *"SteuerTarifLang"* are redundant and therefore, droped. For practical reasons the columns *"SteuerVermoegen_p25"* and *"SteuerVermoegen_p75"* were droped as well.  
Moreover, the columns *"SteuerTarifSort"* and *"KreisSort"* are converted to factors, since those columns are automatically defined as integer number. 
Additionally, the names of the columns do not correspond with the previous data set and therefore, we have to change the following:  

| Original Column Name | New Column Name |
| :------------------  | :-------------  |
|      KreisSort       |  DistrictNumber |
|      SteuerJahr      |      Year       |
|  SteuerVermoegen_p50 |     Wealth      |
|   SteuerTarifSort    |    Category     |

Finally, after all modifications, the data set looks as follows:

```{r drop_columns_wealth, echo = FALSE, include = TRUE, results = 'asis'} 
VermoegenSteuerKreis$SteuerTarifSort <- VermoegenSteuerKreis$SteuerTarifSort %>% as.factor()
VermoegenSteuerKreis$KreisSort <- VermoegenSteuerKreis$KreisSort %>% as.factor()

VermoegenSteuerKreis <- VermoegenSteuerKreis[,! names(VermoegenSteuerKreis) %in% c("KreisLang", "SteuerTarifLang","SteuerVermoegen_p25","SteuerVermoegen_p75")]
VermoegenSteuerKreis <- VermoegenSteuerKreis %>%
  rename(
    DistrictNumber = KreisSort,
    Year = SteuerJahr,
    Wealth = SteuerVermoegen_p50,
    TaxCategory = SteuerTarifSort
    )
kable(VermoegenSteuerKreis[1:6,], caption = "Final data set: Distribution wealth tax per category, district and year")
```

The next graph shows the distribution of wealth per year, tax category and district in Zurich.

```{r plot_wealth, include = TRUE}
ggplot(data = VermoegenSteuerKreis,
                         aes(x = Year,
                             y = Wealth)) +
    geom_point(alpha = 0.4, aes(colour = DistrictNumber)) +
    theme_minimal() +
    facet_wrap(~ TaxCategory, labeller = labeller(TaxCategory = 
      c("0" = "Individual Category",
        "1" = "Family Category",
        "2" = "Single Parent Category"))
    )+ 
    geom_smooth(alpha = 0.1, method = "lm", se = FALSE, 
                aes(colour = DistrictNumber)) +
    ggtitle("Wealth per year and kreis in city of Zurich") + 
    labs(y = "Median value") +
    theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(hjust = 0.5))  +
    scale_color_brewer("Kreis", type = "qual",  palette = "Paired")

```

The previous graph shows the distribution of wealth by district, year and tax category. Since the ordinate is scaled for all tax categories with the same values, it is clearly visible the difference of accumulated wealth between the districts across all and those differences seems to have a clear trend in increasing. The biggest differences between districts can be see in the _family category_ subgraph. The highest values have been observed for district 7 and the lowest values for district 12. District 7, however, has the highest values among all tax categories. District 12 shows as well across all categories the lowest values of accumulated as well. 


## Data set 4: Income distribution of the population in Z端rich, by district
The following data set of dimensions 756x8 variables reflects how the income distribution in absolute terms changed over time per district and per tax class.
The following table shows the accumulated income distribution across all districts of the city of Z端rich between the years 1999 and 2019. 

```{r import_data_income, echo = FALSE, include = TRUE}
EinkommenSteuerKreis <- read.csv('https://data.stadt-zuerich.ch/dataset/fd_median_einkommen_kreis_od1007/download/WIR100OD1007.csv')
kable(EinkommenSteuerKreis[1:6,1:4], caption = "Original data set: Distribution income tax per category, district and year")
kable(EinkommenSteuerKreis[1:6,5:8])
```

Examinating the previous showed data revealed that the data set contains a lot of irrelevant information.
For example, the columns *"KreisSort"* and *"KreisLang"* are redundant, since the first in simply the encoding of the second in number. 
The same applies for the the columns *"SteuerTarifSort"* and *"SteuerTarifLang"*, since the first column, here again, is the encoding of the second in number. However, the columns *"KreisLang"* and *"SteuerTarifLang"* are redundant and therefore, droped. For practical reasons the columns *"SteuerEinkommen_p25"* and *"SteuerEinkommen_p75"* were droped as well.  
Moreover, the columns *"SteuerTarifSort"* and *"KreisSort"* are converted to factors, since those columns are automatically defined as integer number. 
Additionally, the names of the columns do not correspond with the previous data set and therefore, we have to change the following:  

| Original Column Name | New Column Name |
| :------------------  | :-------------  |
|      KreisSort       |  DistrictNumber |
|      SteuerJahr      |      Year       |
|  SteuerEinkommen_p50 |     Income      |
|   SteuerTarifSort    |    Category     |

Finally, after all modifications, the data set looks as follows:

```{r drop_columns_income, echo = FALSE, include = TRUE}
EinkommenSteuerKreis$SteuerTarifSort <- EinkommenSteuerKreis$SteuerTarifSort %>% as.factor()
EinkommenSteuerKreis$KreisSort <- EinkommenSteuerKreis$KreisSort %>% as.factor()

EinkommenSteuerKreis <- EinkommenSteuerKreis[,! names(EinkommenSteuerKreis) %in% c("KreisLang", "SteuerTarifLang","SteuerEinkommen_p25","SteuerEinkommen_p75")]
EinkommenSteuerKreis <- EinkommenSteuerKreis %>%
  rename(
    DistrictNumber = KreisSort,
    Year = SteuerJahr,
    Income = SteuerEinkommen_p50,
    TaxCategory = SteuerTarifSort
    )
kable(EinkommenSteuerKreis[1:6,], caption = "Final data set: Distribution income tax per category, district and year")
```

The next graph shows the distribution of income per year, tax category and district in Zurich.

```{r plot_income, include = TRUE}
ggplot(data = EinkommenSteuerKreis,
                         aes(x = Year,
                             y = Income)) +
    geom_point(alpha = 0.4, aes(colour = DistrictNumber)) +
    theme_minimal() +
    facet_wrap(~ TaxCategory, labeller = labeller(TaxCategory = 
      c("0" = "Individual Category",
        "1" = "Family Category",
        "2" = "Single Parent Category"))
    )+ 
    geom_smooth(alpha = 0.1, method = "lm", se = FALSE, 
                aes(colour = DistrictNumber)) +
    ggtitle("Income per year and district in city of Zurich") + 
    labs(y = "Median value") +
    theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(hjust = 0.5))  +
    scale_color_brewer("Kreis", type = "qual",  palette = "Paired")

```

The previous graph shows the distribution of income by district, year and tax category. Since the ordinate is scaled for all tax categories with the same values, it is clearly visible the difference of accumulated income between the districts across all and those differences seems to have a clear trend in increasing. The biggest differences between districts can be see in the _family category_ subgraph. The highest values have been observed for district 7 and the lowest values for district 12. District 7, however, has the highest values among all tax categories. District 12 shows as well across all categories the lowest values of accumulated as well. 

\newpage
## Combine Wealth and Income data  
The aim of this part is to combine the income and wealth data into one data frame. As a first step, both data frames are combine using the _merge()_ function. The merged data sets of income and wealth data, contains the income data and wealth data per district and tax category combined. 

```{r merging_income_wealth, echo = FALSE, include = TRUE}
# Merge the two frames and drop redundant column KreisLang
EinkommenVermoegenSteuerKreis <- merge(
    EinkommenSteuerKreis, 
    VermoegenSteuerKreis)

kable(EinkommenVermoegenSteuerKreis[1:6,], caption = "Merged income and wealth data")
```
Thereafter, the district name has to be modified in order to match if the data presented in sections concerning *[Data set 1](#Data set 1: Turnout at the city and municipal council elections since 2006, by city district.)* and *[Data set 2](#Data set 2:  Municipal elections vote share, by party and electoral district since 1913.)*: The name of the districts corresponds to the prefix *"Kreis"* followed by *" + "* and the corresponding number. In the case of the *wealth* and *income* data frames, those values have to be transformed and combined as the following correspondence tables shows:  

```{r merging_wealth_income, echo = FALSE, include = TRUE}
# Create a correspondence table between the district names and the district numbers
Names <- data.frame(
  Number = seq(1,12) %>% as.character(),
  Name = c(
    "Kreis 1 + 2", "Kreis 1 + 2", 
    "Kreis 3", "Kreis 4 + 5", 
    "Kreis 4 + 5", "Kreis 6",
    "Kreis 7 + 8", "Kreis 7 + 8",
    "Kreis 9", "Kreis 10",
    "Kreis 11", "Kreis 12")
  )

kable(Names, caption = "Correspondence table between district names and district numbers")

```

Thereafter, several transformations have to be done as follows in order to transform the data into a mergable format:  
- Pivot to a longer format the tables and combine the tax values  
- Group by year, district name and tax type  
- Average the values amount all categories within one district  
- Pivot to wide format again to averaged values  

After the step-by-step implementation of those transformation steps one gets the following data frame: 

```{r transformations_wealth_income, echo = FALSE, include = TRUE}
# Transformations
EinkommenVermoegenSteuerKreis <- EinkommenVermoegenSteuerKreis %>%
  pivot_longer(cols = 4:5, names_to = "TaxType",values_to = "TaxAmount") %>%
  group_by(Year, DistrictNumber, TaxType) %>%
  summarise(TotalTax = mean(TaxAmount) %>% round(3)) %>%
  pivot_wider(names_from = c(TaxType), values_from = TotalTax, names_prefix = "Average ") %>%
  mutate(DistrictNumber = recode(DistrictNumber,
    '1' = "Kreis 1 + 2", 
    '2' = "Kreis 1 + 2", 
    '3' = "Kreis 3", 
    '4' = "Kreis 4 + 5", 
    '5' = "Kreis 4 + 5", 
    '6' = "Kreis 6",
    '7' = "Kreis 7 + 8", 
    '8' = "Kreis 7 + 8",
    '9' = "Kreis 9", 
    '10' = "Kreis 10",
    '11' = "Kreis 11", 
    '12' = "Kreis 12")) %>%
  rename(DistrictName = DistrictNumber) %>%
  group_by(Year, DistrictName) %>%
  summarise_at(c("Average Income","Average Wealth"), ~round(mean(.),3) )#%>% round(3) )#%>% round(3))

kable(EinkommenVermoegenSteuerKreis[1:9,], caption = "Final wealth and income data frame per district and year")
```
\pagebreak
# Merging Data

\pagebreak
# Data Visualization  

\pagebreak
# Fit Model  

\pagebreak
# Chapter of Choice TBD  

\pagebreak
# References 