---
title: | 
  R-Bootcamp Report
author: 
  - Leonid Gavrilyuk^[Hochschule Luzern, leonid.gavrilyuk@stud.hslu.ch]
  - Bernardo Freire Barboza da Cruz^[Hochschule Luzern, bernardo.dacruz@stud.hslu.ch]
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    pdf_document:
        fig_caption: yes
        highlight: pygments
        keep_tex: yes
        number_sections: yes
        fig_width: 16
        fig_height: 9
        df_print: kable
---

\centering
\raggedright
\newpage
\tableofcontents
\pagebreak

```{r setup, include = FALSE}
# Set echo, include, warning, message to FALSE
knitr::opts_chunk$set(
	echo = FALSE, # prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.
	include = FALSE, # prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.
  message = FALSE, # prevents messages that are generated by code from appearing in the finished file.
	warning = FALSE # prevents warnings that are generated by code from appearing in the finished.
)
# Import libraries
library(knitr)
library(lattice)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
#toc: yes
#toc_depth: 4
```


# Introduction 

## Project goal
The goal is to understand the dynamics in the performance of each part in each electoral district of the city. The period of interest is 2006-2018. 
The questions to be answered: what is the dynamic of the voting behaviour in each electoral district, overview of the city elections, identification of  relationship (if any) between such characteristics as voters' education and the election results of the party. 

## Data
To perform analysis, six data sets covering the time period 2006-2018 were retrieved from the Open Data platform of the City of Zürich:

* Turnout at the city and municipal council elections, by city district, since 2006.
* Municipal elections vote share, by party and electoral district, since 1913.
* Turnout at the city and municipal council elections, by age and gender, since 2006.
* Wealth distribution of the population in Zürich, by district, since 1999.
* Income distribution of the population in Zürich, by district, since 1999.

The data sets did not have the same content and were not organised in the same way. Each data set contained some irrelevant information - for example, historical election data since 1913 whereas the time span of interest is 2006-2018. This required data preparation activities. Each data set was prepared, subsequently, all of them were merged into one final table. 

\pagebreak
# Data Preparation 
## Data set 1: Turnout at the city and municipal council elections since 2006, by city district.

The data set of dimensions 136x7 reflects how many people from each city district participated in the last five elections (2006-2018). 

```{r Beteiligung_am_Urnengang 1, echo=FALSE, results='asis', include = TRUE}
#d.gen <- read.table("https://data.stadt-zuerich.ch/dataset/politik_gemeinderatswahlen_btg_urnengang_quartier_od7005/download/POL700OD7005.csv", header = TRUE, sep = ",")
d.gen <- read.table("/Users/leonidgavrilyuk/Desktop/R_Bootcamp/RBootcamp/Beteiligung__nachStadtquartier.csv", header = TRUE, sep = ",")
kable(d.gen[1:6, ], caption = "Original data set: Turnout in the city and municipal council elections since 2006, by city district")

```

Examination of the dataset revealed an important issue: The territorial entity in this dataset is a city district - *"Stadtquartier"*. However, in Zürich, the elections are held across 12 electoral districts - *"Wahlkreise"*. Each electoral district consists of several "Stadtquartiers". For example, electoral district "Kreis 1+2" unites six city districts (they are shown in the "Qname" column in the Table 1 above).  

To address the issue, the following manipulations were performed:

- In the column "Qname", the electoral district is specified in the parentheses: e.g. "Rathaus (Kreis 1)". The content of the parentheses was extracted with the **stringr package** and stored in the created column "DistrictName". 
- Rename the electoral districts to reflect the fact that some city districts are merged for the elections - for example, "Kreis 1" and "Kreis 2" became "Kreis 1+2". This was done with the **dplyr mutate() function**. 
- Assigning levels to the DistrictNamecolumn to prevent ordering alphabetically: Kreis 1+2 is now followed by Kreis 3, and not Kreis 10.
- Calculate the mean values for each group and year using **dplyr group_by() and summarise() functions** (saved as a separate data frame). The results is saved as a separate data frame, with the new column "PercentageOfDistrict".
- Merge the dataframes with the **dplyr inner_join()**. 
- Change "Jahr" and "DistrictName" to factors with the built-in **as.factor()**

```{r Beteiligung_am_Urnengang/Preparation, echo=FALSE, include=FALSE}
#Create the "DistrictName" column that stores the content of the parenthesis. 
#E.g. Rathaus (Kreis 1) - > Kreis 1
#Create the "DistrictName" column that stores the content of the parenthesis. 
#E.g. Rathaus (Kreis 1) - > Kreis 1
library (stringr)
d.gen$DistrictName <- str_extract_all(d.gen$Qname,"\\([^()]+\\)")
d.gen$DistrictName <- substring(d.gen$DistrictName, 2, 
                                      nchar(d.gen$DistrictName)-1)
head(d.gen, 30)

##Create the DistrictNr column that stores only the number of the electoral district.
d.gen$DistrictNr <- str_sub(d.gen$DistrictName, 
                                    start = 6, 
                                    end = -1)
head(d.gen,10)

# to reflect the fact some city districts are merged for the elections (e.g. "Kreis 1+2")
library(dplyr)
d.gen <- d.gen %>%
  mutate(DistrictName = recode(DistrictName, 
                               'Kreis 1' = 'Kreis 1 + 2', 
                               'Kreis 2' = 'Kreis 1 + 2', 
                               'Kreis 4' = 'Kreis 4 + 5',
                               'Kreis 5' = 'Kreis 4 + 5',
                               'Kreis 7' ='Kreis 7 + 8',
                               'Kreis 8' ='Kreis 7 + 8'))
head(d.gen,34)
              
#Calculate mean by each group and year using dplyr's group_by
df_fin <- d.gen %>% 
  dplyr::group_by(Jahr, DistrictName) %>% 
  dplyr::summarise(PercentageOfDistrict =mean(Beteiligung)) 
df_fin$PercentageOfDistrict <- round(df_fin$PercentageOfDistrict, digit=2)
head(df_fin)

#Reorder so that DistrictName is sorted not alphabetically
#Change "DistrictName" to numeric

df_fin$DistrictName  <- factor(df_fin$DistrictName, levels = c("Kreis 1 + 2",
                                                               "Kreis 3",
                                                               "Kreis 4 + 5",
                                                               "Kreis 6",
                                                               "Kreis 7 + 8",
                                                               "Kreis 9",
                                                               "Kreis 10", 
                                                               "Kreis 11", 
                                                               "Kreis 12" ))


#Change "Jahr" and "DistrictName" to factors
df_fin$Jahr <- as.factor(df_fin$Jahr)
sapply(df_fin, class)

#Rename Jahr to English version 
df_fin <- df_fin %>% 
  dplyr::rename(
    Year = Jahr
    )

df_fin <- arrange(df_fin,desc(Year),DistrictName)
head(df_fin, 10)

```

```{r Beteiligung_am_Urnengang_2, echo=FALSE, results='asis', include = TRUE}
kable(df_fin[1:6, ], caption = "Final dataset: Turnout by electoral district")
```

The analysis shows that the amount of voters in each district has grown since 2006 - Zürich residents are becoming more active in exercising their right to vote. Kreis 6 has the highest percentage of active citizens, followed by Kreis 7+8 and Kreis 10. Residents of Kreis 12 are the least interested in the elections people in Zürich. However, when it comes to the percentage of all city voters, Kreis 12 contributes the third largest portion of votes. This means politicians should mobilize residents of this district to gain votes on the city and national level elections. Other important districts are Kreis 7+8 (gives most votes) and Kreis 11 (second place). 

```{r plot_election_per_district, echo=FALSE, include = TRUE}

library(ggplot2)
library(cowplot)
p1 <- ggplot(data=df_fin, aes(x=Year, y=PercentageOfDistrict, group=DistrictName)) +
  geom_line(aes(color=DistrictName))+
  geom_point(aes(color=DistrictName))
plot(p1)

```

## Data set 2:  Municipal elections vote share, by party and electoral district since 1913.
The data set of dimensions 5100x6 shows the results of each party at the elections since 1913. Naturally, it contains a lot of irrelevant information because of the changes that happened sine 1913. For example, for each year there are separate rows for "Kreis 1 (before 2002)", "Kreis 2 (before 2002) and "Kreis 1+2 (after 2006)" - the districts were united in 2002. Some political parties do not exist anymore; some parties changed their names. Additionally, the table is in the long format whereas the final data set requires it to be wide. 

```{r Municipal_elections_vote_share_1, echo=FALSE, results='asis', include = TRUE}
parties <- read.table("https://data.stadt-zuerich.ch/dataset/politik_gemeinderatswahlen_stimmant_seit1913_od7000/download/POL700OD7000.csv", header = TRUE, sep = ",")

kable(parties[1:6, ], caption = "Original data set: Municipal elections vote share, by party and electoral district since 1913.")
```

The following manipulations were performed:

* Choose only relevant time period (years 2006-2018) and eight still existing parties using the **%in% operator**.
* Change the names of the electoral districts. For example, "Kreis 11 (ab 1974)" became simply "Kreis 11" - the content in the parentheses was removed with the  **stringr str_replace() function**. 
* Rename the columns with  the **dplyr %>% rename() function** to keep them in line with the other tables (e.g. "Wahlkreis" to "DistrictName").
* Remove unnecessary columns with the **dplyr %>% select() function**.
* Transform the table into wide format with the **tidyverse pivot_wider() function**.
* Change "Year" and "DistrictName" variables to factors. Visualise with the **tidyverse gather() method and ggplot**
* Merge the set with the first table "Turnout by electoral district" (see part 2.1.) using **inner_join**. 

```{r Municipal_elections_vote_share_2, echo=FALSE, include=FALSE}
#Choose only relevant time period (years 2006-2018) and eight still existing parties.
#Choose only relevant time period (years 2006-2018) and eight still existing parties.

library(dplyr)
parties <- parties[parties$Jahr %in% c(2006, 2010, 2014, 2018), ]

parties <- parties[parties$Partei %in% c("SP", "BGB/SVP", "GPS", "FDP", 
                              "GLP", "CVP/Die Mitte", "AL", "EVP"), ]

parties <- parties[parties$Wahlkreis %in% c("Kreis 1 + 2 (ab 2006)", "Kreis 9",
                                            "Kreis 11 (ab 1974)", "Kreis 3",
                                            "Kreis 4 + 5 (ab 2006)", "Kreis 10",
                                            "Kreis 12 (ab 1974)", "Kreis 6",
                                            "Kreis 7 + 8 (ab 2006)"), ]

#Change the names of the electoral districts.
library(stringr)
parties$Wahlkreis <- str_replace(parties$Wahlkreis, " \\s*\\([^\\)]+\\)", "")
head(parties)

#Rename the columns to keep them in line with the other tables (e.g. "Wahlkreis" to "DistrictName"). 
parties <- parties %>% 
  dplyr::rename(
    DistrictName = Wahlkreis,
    Year = Jahr,
    Party = Partei,
    Result = Stimmenanteil) %>% 
  select (-ParteiNr, -WahlkreisSort)

parties$DistrictName  <- factor(parties$DistrictName, levels = c("Kreis 1 + 2",
                                                               "Kreis 3", 
                                                      "Kreis 4 + 5", "Kreis 6",
                                                      'Kreis 7 + 8', "Kreis 9",
                                                      "Kreis 10", 
                                                      "Kreis 11", "Kreis 12" ))

#Transform the table into wide format.
parties <- tidyr::pivot_wider(parties, 
                                   names_from = "Party",
                                   values_from = "Result")
parties <- na.omit(parties)
parties$Year <- as.factor(parties$Year)

df_3 <- df_fin %>% dplyr::inner_join(parties)
```

```{r Municipal_elections_vote_share_3, echo=FALSE, results='asis', include = TRUE}

kable (parties[1:8, ], caption = "Final dataset: Municipal elections vote share, by party and electoral district, 2006-2018.")

```

The visualisation shows that parties have been demonstrating roughly the same result since 2006. Kreis 7+8 seems to be the bastion of FDP. Most active supporters of AL-Alternative Liste live in Kreis 4+5. Electoral districts Kreis 3, Kreis 4+5, Kreis 6 and Kreis 10 deliver a larger amount of votes to SP than the citizens of other districts. Voters in Kreis 7+8 do not like to vote for socialists. A curious phenomenon can be observed when it comes to the green parties - GLP and GPS. They seem to grow at expense of other parties: FDP and SP, respectively. 

```{r plot Parties in Districts, warning=FALSE, include = TRUE}
parties %>% 
  gather(Party, Result, -c(Year, DistrictName)) %>% 
  ggplot(aes(reorder(DistrictName, Year), Result)) +
  geom_col(aes(fill = Party)) +
  scale_fill_manual(
    values = c("#F8766D", "chocolate3", "orange", "darkblue", "purple", "#7CAE00","darkgreen", "brown1")
  ) +
  facet_grid(~ Year) +
  theme(axis.text.x = element_text(color = "grey20", size = 8, angle = 90, vjust = 0.4, hjust=1)) +
  theme(axis.title.x=element_blank()) +
  theme(plot.margin = margin(10, 10, 10, 110)) +
  labs(title = "Party results by district and year")
```

The data set was merged with the Dataset 1:
```{r Municipal elections vote share 4, echo=FALSE, results='asis', , include = TRUE}
kable (df_3[1:8, ], caption = "Merged dataset: Municipal elections turnout and vote share by party, 2006-2018.")
```
\pagebreak

## Data set 3: Wealth distribution of the population in Zürich, by district
The data set of dimensions 756x8 variables reflects how the wealth distribution in absolute terms changed over time per district and per tax class. The following table shows the accumulated wealth distribution across all districts of the city of Zürich between the years 1999 and 2019. 

```{r import_data_wealth, echo = FALSE, cache=TRUE, include = FALSE, results='asis'} 
# Set cache to true
VermoegenSteuerKreis <- read.csv('https://data.stadt-zuerich.ch/dataset/fd_median_vermoegen_kreis_od1008/download/WIR100OD1008.csv')
```

```{r initial_data_wealth, echo = FALSE, cache=TRUE, include = TRUE, results='asis'} 
kable(VermoegenSteuerKreis[1:6,1:4], caption = "Original data set: Distribution wealth tax per category, district and year")
kable(VermoegenSteuerKreis[1:6,4:8])
```

Examinating the previous showed data revealed that the data set contains a lot of irrelevant information.
For example, the columns *"KreisSort"* and *"KreisLang"* are redundant, since the first in simply the encoding of the second in number. 
The same applies for the the columns *"SteuerTarifSort"* and *"SteuerTarifLang"*, since the first here again, is the encoding of the second in number. However, the columns *"KreisLang"* and *"SteuerTarifLang"* are redundant and therefore, droped. For practical reasons the columns *"SteuerVermoegen_p25"* and *"SteuerVermoegen_p75"* were droped as well.  
Moreover, the columns *"SteuerTarifSort"* and *"KreisSort"* are converted to factors, since those columns are automatically defined as integer number. 
Additionally, the names of the columns do not correspond with the previous data set and therefore, we have to change the following:  

| Original Column Name | New Column Name |
| :------------------  | :-------------  |
|      KreisSort       |  DistrictNumber |
|      SteuerJahr      |      Year       |
|  SteuerVermoegen_p50 |     Wealth      |
|   SteuerTarifSort    |    Category     |

Finally, after all modifications, the data set looks as follows:

```{r drop_columns_wealth, echo = FALSE, include = TRUE, results = 'asis'} 
VermoegenSteuerKreis$SteuerTarifSort <- VermoegenSteuerKreis$SteuerTarifSort %>% as.factor()
VermoegenSteuerKreis$KreisSort <- VermoegenSteuerKreis$KreisSort %>% as.factor()

VermoegenSteuerKreis <- VermoegenSteuerKreis[,! names(VermoegenSteuerKreis) %in% c("KreisLang", "SteuerTarifLang","SteuerVermoegen_p25","SteuerVermoegen_p75")]
VermoegenSteuerKreis <- VermoegenSteuerKreis %>%
  dplyr::rename(
    DistrictNumber = KreisSort,
    Year = SteuerJahr,
    Wealth = SteuerVermoegen_p50,
    TaxCategory = SteuerTarifSort
    )
kable(VermoegenSteuerKreis %>% head(), caption = "Final data set: Distribution wealth tax per category, district and year")
```

The next graph shows the distribution of wealth per year, tax category and district in Zurich.

```{r plot_wealth, include = TRUE}
ggplot(data = VermoegenSteuerKreis,
                         aes(x = Year,
                             y = Wealth)) +
    geom_point(alpha = 0.4, aes(colour = DistrictNumber)) +
    theme_minimal() +
    facet_wrap(~ TaxCategory, labeller = labeller(TaxCategory = 
      c("0" = "Individual Category",
        "1" = "Family Category",
        "2" = "Single Parent Category"))
    )+ 
    geom_smooth(alpha = 0.1, method = "lm", se = FALSE, 
                aes(colour = DistrictNumber)) +
    ggtitle("Wealth per year and kreis in city of Zurich") + 
    labs(y = "Median value") +
    theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(hjust = 0.5))  +
    scale_color_brewer("Kreis", type = "qual",  palette = "Paired")

```

The previous graph shows the distribution of wealth by district, year and tax category. Since the ordinate is scaled for all tax categories with the same values, it is clearly visible the difference of accumulated wealth between the districts across all and those differences seems to have a clear trend in increasing. The biggest differences between districts can be see in the _family category_ subgraph. The highest values have been observed for district 7 and the lowest values for district 12. District 7, however, has the highest values among all tax categories. District 12 shows as well across all categories the lowest values of accumulated as well. 


## Data set 4: Income distribution of the population in Zürich, by district
The following data set of dimensions 756x8 variables reflects how the income distribution in absolute terms changed over time per district and per tax class.
The following table shows the accumulated income distribution across all districts of the city of Zürich between the years 1999 and 2019. 

```{r import_data_income, echo = FALSE, include = TRUE}
EinkommenSteuerKreis <- read.csv('https://data.stadt-zuerich.ch/dataset/fd_median_einkommen_kreis_od1007/download/WIR100OD1007.csv')
kable(EinkommenSteuerKreis[1:6,1:4], caption = "Original data set: Distribution income tax per category, district and year")
kable(EinkommenSteuerKreis[1:6,5:8])
```

Examinating the previous showed data revealed that the data set contains a lot of irrelevant information.
For example, the columns *"KreisSort"* and *"KreisLang"* are redundant, since the first in simply the encoding of the second in number. 
The same applies for the the columns *"SteuerTarifSort"* and *"SteuerTarifLang"*, since the first column, here again, is the encoding of the second in number. However, the columns *"KreisLang"* and *"SteuerTarifLang"* are redundant and therefore, droped. For practical reasons the columns *"SteuerEinkommen_p25"* and *"SteuerEinkommen_p75"* were droped as well.  
Moreover, the columns *"SteuerTarifSort"* and *"KreisSort"* are converted to factors, since those columns are automatically defined as integer number. 
Additionally, the names of the columns do not correspond with the previous data set and therefore, we have to change the following:  

| Original Column Name | New Column Name |
| :------------------  | :-------------  |
|      KreisSort       |  DistrictNumber |
|      SteuerJahr      |      Year       |
|  SteuerEinkommen_p50 |     Income      |
|   SteuerTarifSort    |    Category     |

Finally, after all modifications, the data set looks as follows:

```{r drop_columns_income, echo = FALSE, include = TRUE}
EinkommenSteuerKreis$SteuerTarifSort <- EinkommenSteuerKreis$SteuerTarifSort %>% as.factor()
EinkommenSteuerKreis$KreisSort <- EinkommenSteuerKreis$KreisSort %>% as.factor()

EinkommenSteuerKreis <- EinkommenSteuerKreis[,! names(EinkommenSteuerKreis) %in% c("KreisLang", "SteuerTarifLang","SteuerEinkommen_p25","SteuerEinkommen_p75")]
EinkommenSteuerKreis <- EinkommenSteuerKreis %>%
  dplyr::rename(
    DistrictNumber = KreisSort,
    Year = SteuerJahr,
    Income = SteuerEinkommen_p50,
    TaxCategory = SteuerTarifSort
    )
kable(EinkommenSteuerKreis %>% head(), caption = "Final data set: Distribution income tax per category, district and year")
```

The next graph shows the distribution of income per year, tax category and district in Zurich.

```{r plot_income, include = TRUE}
ggplot(data = EinkommenSteuerKreis,
                         aes(x = Year,
                             y = Income)) +
    geom_point(alpha = 0.4, aes(colour = DistrictNumber)) +
    theme_minimal() +
    facet_wrap(~ TaxCategory, labeller = labeller(TaxCategory = 
      c("0" = "Individual Category",
        "1" = "Family Category",
        "2" = "Single Parent Category"))
    )+ 
    geom_smooth(alpha = 0.1, method = "lm", se = FALSE, 
                aes(colour = DistrictNumber)) +
    ggtitle("Income per year and district in city of Zurich") + 
    labs(y = "Median value") +
    theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(hjust = 0.5))  +
    scale_color_brewer("Kreis", type = "qual",  palette = "Paired")

```

The previous graph shows the distribution of income by district, year and tax category. Since the ordinate is scaled for all tax categories with the same values, it is clearly visible the difference of accumulated income between the districts across all and those differences seems to have a clear trend in increasing. The biggest differences between districts can be see in the _family category_ subgraph. The highest values have been observed for district 7 and the lowest values for district 12. District 7, however, has the highest values among all tax categories. District 12 shows as well across all categories the lowest values of accumulated as well. 

\newpage
## Education data
The following data set contains 39x5 variables on type of education and year of the complete city of Zürich. This data set allows us to try to infer the change in education per type in the city of Zürich and interpolate the change of education type on a district respectively on a neighborhood level.  

```{r import_data_education, echo = FALSE, include = TRUE}
EducationYear <- read.csv('https://data.stadt-zuerich.ch/dataset/bfs_bev_bildungsstand_seit1970_od1002/download/BIL100OD1002.csv')
kable(EducationYear %>% head(), caption = "Original data set: Education distribution per category and year")
```

The following graphs shows the change of education in the city of Zürich between the year 1970 and 2018. 

```{r plot_education, include = TRUE}
EducationYear <- EducationYear %>%
  mutate(Bildungsstand = recode(Bildungsstand,
    'Obligatorische Schule' = 'PrimarySchool',
    'Sekundarstufe II' = 'SecondarySchool',
    'Tertiärstufe' = 'AcademiaDegree'))

ggplot(data = EducationYear,
                         aes(x = Jahr,
                             y = AntBev)) +
    geom_point(alpha = 0.4, aes(colour = Bildungsstand)) +
    theme_minimal() +
    facet_wrap(~ Bildungsstand) + 
    geom_smooth(alpha = 0.1, method = "lm", se = FALSE, 
                aes(colour = Bildungsstand)) +
    ggtitle("Type education of inhabitants of the city of Zurich") + 
    labs(y = "Proportion of inhabitants") +
    theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(hjust = 0.5))  +
    scale_color_brewer("Type of education", type = "qual",  palette = "Paired")

```

The previous graph shows, that the number of inhabitants without an academical degree is decreasing in the course of time since 1970 in the City of Zürich, while the number of persons having a university degree is increasing. First, the values of the previous data frame have to be re-arranged using the *pivot_wide()* and the names of the education type are renamed to match the correspondence table 

```{r pivot_education2, echo = FALSE, include = TRUE}
EducationYearPivot <- EducationYear %>%
  select(-c("untAntBevKI","obAntBevKI")) %>%
  pivot_wider(names_from = Bildungsstand,
              values_from = AntBev,
              values_fill = 0) %>%
  dplyr::rename('Year' = 'Jahr') %>%
  mutate(DeltaYear = Year - 1970)

kable(EducationYearPivot %>% head(), caption = "Pivoted data set: Education distribution per category and year")
```

In order to be able to reproduce this phenomena in the previous data set, the parameters of theses changes is going to calculated using the *lm()* function. The used formula is the following:  

$$N_{AntBev} = c + \frac{\Delta d_{i}}{\Delta t} \cdot t $$

Applying the previous showed formula to the other data set one gets the following values

```{r pivot_education1, echo = FALSE, include = TRUE}
approximation <- data.frame(
  PrimarySchool = lm(PrimarySchool ~ DeltaYear, data = EducationYearPivot) %>% summary() %>% coef() %>% .[,'Estimate'],
  SecondarySchool = lm(SecondarySchool ~ DeltaYear, data = EducationYearPivot) %>% summary() %>% coef() %>% .[,'Estimate'],
  AcademiaDegree = lm(AcademiaDegree ~ DeltaYear, data = EducationYearPivot) %>% summary() %>% coef() %>% .[,'Estimate']
  )

kable(approximation, caption = "Coefficients of the linear model depending on the education type")
```

The previous table shows the coefficients of the linear model of each education type. Before further transformation, we load a further data frame. The data set of dimensions 138x6 variables reflects how the education of the inhabitants changed over time per district and per education class. The following table shows the proportion of education per districts of the city of Zürich for the year 2021. The data set is updated on a yearly basis. 

```{r import_data_education_2021, echo = FALSE, include = TRUE}
EducationDistrict <- read.csv('https://data.stadt-zuerich.ch/dataset/bfs_bev_bildungsstand_statquartier_od1012/download/BIL101OD1012.csv')
EducationDistrict <- EducationDistrict %>%
  mutate(RaumSort = as.factor(RaumSort),
         Bildungsstand = as.factor(Bildungsstand),
         RaumLang = as.character(RaumLang)
         )
kable(EducationDistrict %>% head(), caption = "Original data set: Education distribution per category and district for the year 2021")
```

The column *"RaumSort"* encodes the district number and corresponding neighborhood within the district. The last digit describes the neighborhood and the first one (or two) digit the district number. The column *"RaumLang"* describes the district and neighborhood name and the column *"Bildungsstand"* describes the type of education as follows:  

```{r correspondence_table_education, echo = FALSE, include = TRUE}
correspondence_table_education <- data.frame(
  EducationNumber = c(1,2,3),
  Meaning = c("Primary school", "Secondary school", "Academia degree")) %>%
  mutate(EducationNumber = as.factor(EducationNumber))

kable(correspondence_table_education, caption = "Education ecoding: Education number key vs. meaning in words")
```

Where type _1_ describes the nine complete year of the mandatory school program, _2_ describes either a professional degree or high-school diploma and _3_ an academical degree (Bachelor's degree and higher). The columns *"untAntBevKI"* and *"obAntBevKI"* describes the lower and upper portion of the confidence interval of the values per education. 
Summarzing, the data frame is going to be updated as follows:  
- *"Bildungsstand"* is update with the meaning as described in the previous table  
- Columns *"untAntBevKI"* and *"obAntBevKI"* are droped  
- Column *"Year"* is added with value *2021*  
- Column *"RaumSort"* is transformed to column *"DistrictNumer"*  
- District designation adapted  
- District summarized according to voting data frames

Those transformations steps leads to the following data frame: 

```{r transformation_education_district, echo = FALSE, include = TRUE}
EducationDistrictPivot <- EducationDistrict %>%
  mutate(Year = 2021) %>%
  mutate(Bildungsstand = recode(Bildungsstand,
      '1' = 'PrimarySchool',
      '2' = 'SecondarySchool',
      '3' = 'AcademiaDegree')) %>%
  .[,!names(EducationDistrict) %in% c("untAntBevKI","obAntBevKI")] %>%
  mutate(DistrictNumber = str_sub(.$RaumSort, start = 1, end = -2)) %>%
  .[,!names(EducationDistrict) %in% c("RaumSort","RaumLang")] %>%
  .[,c(3,4,1,2)] %>%
  group_by(DistrictNumber,Bildungsstand) %>%
  summarise(AntBev = mean(AntBev)) %>%
  pivot_wider(names_from = Bildungsstand, values_from = AntBev) %>%
  mutate(DistrictNumber = as.numeric(DistrictNumber)) %>%
  .[order(.$DistrictNumber),] %>%
  mutate(Year = 2021) %>%
  mutate(DistrictNumber = recode(DistrictNumber,
    '1' = "Kreis 1 + 2", 
    '2' = "Kreis 1 + 2", 
    '3' = "Kreis 3", 
    '4' = "Kreis 4 + 5", 
    '5' = "Kreis 4 + 5", 
    '6' = "Kreis 6",
    '7' = "Kreis 7 + 8", 
    '8' = "Kreis 7 + 8",
    '9' = "Kreis 9", 
    '10' = "Kreis 10",
    '11' = "Kreis 11", 
    '12' = "Kreis 12")) %>%
  dplyr::rename(DistrictName = DistrictNumber) %>%
  group_by(DistrictName) %>%
  summarise_at(c("PrimarySchool","SecondarySchool","AcademiaDegree"), ~round(mean(.),1)) %>%
  mutate(Year = 2021) %>%
  .[,c(5,1,2,3,4)]
  
kable(EducationDistrictPivot, caption = "Transformed data frame for education in year 2021")
```

The previous table shows the transformed data for the year 2021. Now, taking into account the previously calculated *[lm coefficients](tab:pivot_education1)* one can extrapolate values for the missing years of the data frame. 

\pagebreak
# Merging Data
## Combine wealth and income data  
The aim of this part is to combine all data sets into one. As a first step, data frames 3 and 4 are combine using the _merge()_ function. The merged data sets of income and wealth data, contains the income data and wealth data per district and tax category combined. 

```{r merging_income_wealth, echo = FALSE, include = TRUE}
# Merge the two frames and drop redundant column KreisLang
EinkommenVermoegenSteuerKreis <- merge(
    EinkommenSteuerKreis, 
    VermoegenSteuerKreis)

kable(EinkommenVermoegenSteuerKreis %>% head(), caption = "Merged income and wealth data")
```
Thereafter, the district name has to be modified in order to match if the data presented in sections concerning *[Data set 1](#Data set 1: Turnout at the city and municipal council elections since 2006, by city district.)* and *[Data set 2](#Data set 2:  Municipal elections vote share, by party and electoral district since 1913.)*: The name of the districts corresponds to the prefix *"Kreis"* followed by *" + "* and the corresponding number. In the case of the *wealth* and *income* data frames, those values have to be transformed and combined as the following correspondence tables shows:  

```{r merging_wealth_income, echo = FALSE, include = TRUE}
# Create a correspondence table between the district names and the district numbers
Names <- data.frame(
  Number = seq(1,12) %>% as.character(),
  Name = c(
    "Kreis 1 + 2", "Kreis 1 + 2", 
    "Kreis 3", "Kreis 4 + 5", 
    "Kreis 4 + 5", "Kreis 6",
    "Kreis 7 + 8", "Kreis 7 + 8",
    "Kreis 9", "Kreis 10",
    "Kreis 11", "Kreis 12")
  )

kable(Names, caption = "Correspondence table between district names and district numbers")

```

Thereafter, several transformations have to be done as follows in order to transform the data into a mergable format:  
- Pivot to a longer format the tables and combine the tax values  
- Group by year, district name and tax type  
- Sum the values amount all categories within one district  
- Pivot to wide format again to averaged values  

After the step-by-step implementation of the transformation steps one gets the following data frame: 

```{r transformations_wealth_income, echo = FALSE, include = TRUE}
# Transformations
EinkommenVermoegenSteuerKreis <- EinkommenVermoegenSteuerKreis %>%
  pivot_longer(cols = 4:5, names_to = "TaxType",values_to = "TaxAmount") %>%
  group_by(Year, DistrictNumber, TaxType) %>%
  summarise(TotalTax = sum(TaxAmount) %>% round(3)) %>%
  pivot_wider(names_from = c(TaxType), values_from = TotalTax, names_prefix = "SumTax") %>%
  mutate(DistrictNumber = recode(DistrictNumber,
    '1' = "Kreis 1 + 2", 
    '2' = "Kreis 1 + 2", 
    '3' = "Kreis 3", 
    '4' = "Kreis 4 + 5", 
    '5' = "Kreis 4 + 5", 
    '6' = "Kreis 6",
    '7' = "Kreis 7 + 8", 
    '8' = "Kreis 7 + 8",
    '9' = "Kreis 9", 
    '10' = "Kreis 10",
    '11' = "Kreis 11", 
    '12' = "Kreis 12")) %>%
  rename(DistrictName = DistrictNumber) %>%
  group_by(Year, DistrictName) %>%
  summarise_at(c("SumTaxIncome","SumTaxWealth"), ~round(sum(.),3) )#%>% round(3) )#%>% round(3))

kable(EinkommenVermoegenSteuerKreis %>% head(), caption = "Final wealth and income data frame per district and year")
```
## Merge all data sets
Finally, all data sets are combined into one: 

```{r final_dataset, echo = FALSE, include = TRUE}
# Transformations
EinkommenVermoegenSteuerKreis <- EinkommenVermoegenSteuerKreis[EinkommenVermoegenSteuerKreis$Year %in% c("2006", "2010", "2014", "2018"), ]
EinkommenVermoegenSteuerKreis$Year <- as.factor(EinkommenVermoegenSteuerKreis$Year)
df_final <- EinkommenVermoegenSteuerKreis %>% inner_join(df_3)
kable(df_final[1:6,1:4], caption = "Final dataset")
kable(df_final[1:6,5:13])
```
 

\pagebreak
# Chapter of choice - Maps with ggplot and sf
As a chapter of choice, we have explored creation of maps in ggplot and sf. 

```{r Maps 1, echo=FALSE, include=FALSE}
library(ggplot2)
library(sf)
library(osmdata)
library(ggmap)
## Load files with map information
zh <- st_read("/Users/leonidgavrilyuk/Desktop/R_Bootcamp/RBootcamp/map_data/stzh.adm_zaehlkreise_a.shp") 
zh <- zh %>%
  dplyr::mutate(bezeichnun = recode(bezeichnun, 
                             "3" = "Kreis 3", 
                             "6" = "Kreis 6",
                             "9" = "Kreis 9","10" = "Kreis 10",
                             "11" = "Kreis 11",
                             "12" = "Kreis 12",
                             '1 und 2' = 'Kreis 1 + 2', 
                               '4 und 5' = 'Kreis 4 + 5',
                               '7 und 8' ='Kreis 7 + 8'))

zh <- zh %>%
  mutate(kuerzel = recode(kuerzel, 
                             '1 und 2' = '1+2', 
                             '4 und 5' = '4+5',
                             '7 und 8' ='7+8'))

zh$bezeichnun  <- factor(zh$bezeichnun, levels = c("Kreis 1 + 2","Kreis 3", 
                                                      "Kreis 4 + 5", "Kreis 6",
                                                      'Kreis 7 + 8', "Kreis 9", 
                                                   "Kreis 10", 
                                                      "Kreis 11", "Kreis 12" ))
zh <- zh[order(zh$bezeichnun),] 

zh <- zh %>% 
  dplyr::rename(
    DistrictName = bezeichnun
    )

results <- df_final[df_final$Year %in% c("2018"), ]

zh <- zh %>% dplyr::inner_join(results)
head(zh, 10)
```

```{r plot map, include = TRUE}
dim(zh)
ggplot(data = zh) +
  geom_sf(aes(fill = SP)) +
  scale_fill_viridis_c(trans = "sqrt") +
  geom_sf_label(aes(label = kuerzel), colour = "white") +
  geom_sf_text(aes(label = kuerzel), colour = "black", size=2,family="sans") +
  labs(fill = "2018 SP results (%)")

```


\pagebreak
# Data Visualization  

\pagebreak
# Fit Model 

\pagebreak
# References 